<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Î§ÏÎ¿Î½Î¿Î£Ï…Î½Î±Î¯ÏƒÎ¸Î·Î¼Î± 24</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --card2:#0f1730;
      --text:#eaf0ff;
      --muted:#b8c3e6;
      --border:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --btn:#1a2a55;
      --btn2:#20356b;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 600px at 20% 10%, rgba(90,120,255,.25), transparent 55%),
                  radial-gradient(900px 600px at 80% 20%, rgba(255,120,210,.18), transparent 55%),
                  radial-gradient(900px 600px at 60% 90%, rgba(0,255,200,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 18px 10px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: conic-gradient(from 180deg,
        #ffd400, #ff8a00, #ff4fd8, #22c55e, #5ad7ff, #a78bfa,
        #d1d5db, #6b7280, #1f3b88, #a16207, #ef4444, #111827, #7c3aed, #ffffff);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.18);
    }
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .wrap{max-width:1180px;margin:0 auto;padding:0 18px 22px}

    .grid{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.12);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card .bd{padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input[type="text"], input[type="number"], select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    input[type="number"]{appearance:textfield}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .pillbar{display:flex;flex-wrap:wrap;gap:8px}
    .pill{
      border:1px solid var(--border);
      background: rgba(0,0,0,.20);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      user-select:none;
      transition:.15s transform,.15s background, .15s opacity;
    }
    .pill:hover{transform:translateY(-1px); background: rgba(255,255,255,.08);}
    .pill.active{outline:2px solid rgba(255,255,255,.45); background: rgba(255,255,255,.10);}

    .btnbar{display:flex;flex-wrap:wrap;gap:8px}
    button{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-size:13px;
      transition:.15s transform,.15s background;
    }
    button:hover{transform:translateY(-1px); background: rgba(255,255,255,.10);}
    button.primary{background: linear-gradient(180deg, rgba(90,120,255,.35), rgba(90,120,255,.12));}
    button.good{background: linear-gradient(180deg, rgba(34,197,94,.35), rgba(34,197,94,.12));}
    button.bad{background: linear-gradient(180deg, rgba(239,68,68,.35), rgba(239,68,68,.12));}

    .hours{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:8px;
      padding:14px;
    }
    @media (max-width: 980px){
      .hours{grid-template-columns: repeat(4, minmax(0, 1fr));}
    }
    .hour{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 10px 9px;
      background: rgba(0,0,0,.18);
      cursor:pointer;
      position:relative;
      min-height:64px;
    }
    .hour.sel{outline:2px solid rgba(255,255,255,.55);}
    .hour .t{font-weight:650;font-size:12px}
    .hour .mini{margin-top:6px;font-size:11px;color:var(--muted);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:999px;border:1px solid rgba(255,255,255,.35);display:inline-block}
    .tag{
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
    }
    .tag.safe{border-color: rgba(34,197,94,.55);}
    .tag.risk{border-color: rgba(239,68,68,.55);}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:12px 0}

    .palette{
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap:8px;
    }
    @media (max-width: 980px){
      .palette{grid-template-columns: repeat(5, minmax(0, 1fr));}
    }
    .sw{
      border-radius:16px;
      padding:12px 8px;
      border:1px solid var(--border);
      cursor:pointer;
      text-align:center;
      user-select:none;
      min-height:56px;
      display:flex;flex-direction:column;justify-content:center;gap:6px;
      background: rgba(0,0,0,.08);
      transition:.15s transform,.15s background;
    }
    .sw:hover{transform:translateY(-1px); background: rgba(255,255,255,.06);}
    .sw .c{width:24px;height:24px;border-radius:10px;margin:0 auto;border:1px solid rgba(0,0,0,.25)}
    .sw.active{outline:2px solid rgba(255,255,255,.55);}
    .hint{
      background: rgba(255,255,255,.06);
      border:1px dashed rgba(255,255,255,.18);
      padding:10px 12px;border-radius:16px;
      font-size:12px;color:var(--muted);
    }
  </style>
</head>
<body>
  <header class="wrap">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Î§ÏÎ¿Î½Î¿Î£Ï…Î½Î±Î¯ÏƒÎ¸Î·Î¼Î± 24</h1>
        <div class="sub">Î“ÏÎ®Î³Î¿ÏÎ· Ï‡Î±ÏÏ„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ· ÏƒÏ…Î½Î±Î¹ÏƒÎ¸Î®Î¼Î±Ï„Î¿Ï‚ â€“ ÏƒÏ‡Î­ÏƒÎµÏ‰Î½ â€“ Î³ÎµÎ³Î¿Î½ÏŒÏ„Ï‰Î½ ÏƒÎµ 24 ÏÏÎµÏ‚</div>
      </div>
    </div>
    <div class="btnbar">
      <button id="btnSleep" class="primary" title="Î“Î­Î¼Î¹ÏƒÎµ Î³ÏÎ®Î³Î¿ÏÎ± ÏÏÎµÏ‚ ÏÏ€Î½Î¿Ï…">ğŸŒ™ Sleep block</button>
      <button id="btnCopyPrev" title="Î‘Î½Ï„Î­Î³ÏÎ±ÏˆÎµ Ï„Î·Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· ÏÏÎ±">âª Copy prev</button>
      <button id="btnApplyRange" title="Î•Ï†Î¬ÏÎ¼Î¿ÏƒÎµ ÏƒÎµ ÎµÏÏÎ¿Ï‚ Ï‰ÏÏÎ½">ğŸ§© Apply range</button>
      <button id="btnExportJSON" class="good">â¬‡ Export JSON</button>
      <button id="btnExportCSV" class="good">â¬‡ Export CSV</button>
      <button id="btnReset" class="bad">ğŸ§¹ Reset</button>
    </div>
  </header>

  <div class="wrap grid">
    <!-- LEFT: Participant + editor -->
    <section class="card">
      <div class="hd">
        <div>
          <div style="font-weight:700">Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î±</div>
          <div class="small">Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î³ÏÎ®Î³Î¿ÏÎ±, Î³Î¯Î½ÎµÏ„Î±Î¹ autosave.</div>
        </div>
        <div class="small" id="saveStatus">â— saved</div>
      </div>
      <div class="bd">
        <div class="row">
          <div>
            <label for="name">ÎŒÎ½Î¿Î¼Î± *</label>
            <input id="name" type="text" placeholder="Ï€.Ï‡. ÎœÎ±ÏÎ¯Î±" />
          </div>
          <div>
            <label for="age">Î—Î»Î¹ÎºÎ¯Î± *</label>
            <input id="age" type="number" min="1" max="18" placeholder="Ï€.Ï‡. 9" />
          </div>
        </div>

        <label>Î¦ÏÎ»Î¿</label>
        <div class="pillbar" id="sexPills">
          <div class="pill" data-sex="Î‘Î³ÏŒÏÎ¹">ğŸ‘¦ Î‘Î³ÏŒÏÎ¹</div>
          <div class="pill" data-sex="ÎšÎ¿ÏÎ¯Ï„ÏƒÎ¹">ğŸ‘§ ÎšÎ¿ÏÎ¯Ï„ÏƒÎ¹</div>
        </div>

        <div class="divider"></div>

        <div class="hint">
          âœ… Tip: Î Î¬Ï„Î± Î¼Î¯Î± ÏÏÎ± Î´ÎµÎ¾Î¹Î¬ ÎºÎ±Î¹ ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î¼ÏŒÎ½Î¿ Ï„Î± Î²Î±ÏƒÎ¹ÎºÎ¬.  
          Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ <b>Copy prev</b> Î® <b>Apply range</b> Î³Î¹Î± Î½Î± Ï„ÎµÎ»ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Ï€Î¿Î»Ï Î³ÏÎ®Î³Î¿ÏÎ±.
        </div>

        <div class="divider"></div>

        <div class="flex">
          <div>
            <div class="small">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÏÏÎ±</div>
            <div style="font-size:20px;font-weight:800" id="selectedHourLabel">00:00</div>
          </div>
          <div class="btnbar" style="margin-left:auto">
            <button id="btnSafeMost" class="good" title="Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎµ Ï„Î·Î½ ÏÏÎ± Ï€Î¿Ï… Î½Î¹ÏÎ¸ÎµÎ¹Ï‚ Î Î™ÎŸ Î±ÏƒÏ†Î±Î»Î®Ï‚">âœ… Most safe</button>
            <button id="btnSafeLeast" class="bad" title="Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎµ Ï„Î·Î½ ÏÏÎ± Ï€Î¿Ï… Î½Î¹ÏÎ¸ÎµÎ¹Ï‚ Î›Î™Î“ÎŸÎ¤Î•Î¡ÎŸ Î±ÏƒÏ†Î±Î»Î®Ï‚">âŒ Least safe</button>
          </div>
        </div>

        <label>Î£Ï…Î½Î±Î¯ÏƒÎ¸Î·Î¼Î± (Ï‡ÏÏÎ¼Î±)</label>
        <div class="palette" id="palette"></div>

        <label>Î ÏŒÏƒÎ¿ Î´Ï…Î½Î±Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î±Ï…Ï„ÏŒ Ï€Î¿Ï… Î½Î¹ÏÎ¸ÎµÎ¹Ï‚;</label>
        <div class="pillbar" id="intensityPills"></div>
        <div class="small" id="intensityHint" style="margin-top:6px">Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï€ÏÏÏ„Î± Ï‡ÏÏÎ¼Î±.</div>

        <label for="withWhom">ÎœÎµ Ï€Î¿Î¹Î¿Î½ ÎµÎ¯ÏƒÎ±Î¹ ÎºÏ…ÏÎ¯Ï‰Ï‚;</label>
        <select id="withWhom"></select>

        <label for="events">Î¤Î¹ ÏƒÏ…Î¼Î²Î±Î¯Î½ÎµÎ¹ ÎºÏ…ÏÎ¯Ï‰Ï‚; (Ï€Î¿Î»Î»Î¬)</label>
        <select id="events" multiple size="8"></select>
        <div class="small">ÎšÏÎ¬Ï„Î± Ï€Î±Ï„Î·Î¼Î­Î½Î¿ Ctrl/Command Î³Î¹Î± Ï€Î¿Î»Î»Î±Ï€Î»Î® ÎµÏ€Î¹Î»Î¿Î³Î®.</div>

        <label for="location">Î Î¿Ï Î²ÏÎ¯ÏƒÎºÎµÏƒÎ±Î¹;</label>
        <select id="location"></select>

        <label for="frequency">Î‘Ï…Ï„ÏŒ Ï€Î¿Ï… Î­Î²Î±Î»ÎµÏ‚ ÏƒÏ…Î¼Î²Î±Î¯Î½ÎµÎ¹â€¦</label>
        <select id="frequency"></select>

        <div class="divider"></div>

        <button id="btnValidate" class="primary" style="width:100%">ğŸ” ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ (validation)</button>
        <div id="validationMsg" class="small" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- RIGHT: 24h grid -->
    <section class="card">
      <div class="hd">
        <div>
          <div style="font-weight:700">24Ï‰ÏÎ· Î“ÏÎ±Î¼Î¼Î®</div>
          <div class="small">Î Î¬Ï„Î± ÏÏÎ± â†’ ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬.</div>
        </div>
        <div class="small">Î£Ï„ÏŒÏ‡Î¿Ï‚: <b>&lt; 5 Î»ÎµÏ€Ï„Î¬</b></div>
      </div>
      <div class="hours" id="hoursGrid"></div>
    </section>
  </div>

<script>
  // ------- Data model -------
  const HOURS = Array.from({length:24}, (_,i)=>String(i).padStart(2,'0') + ":00");

  const EMOTIONS = [
    {key:"yellow",  color:"#FFD400", label:"Î§Î±ÏÎ¬ / Î•Ï…Ï„Ï…Ï‡Î¯Î±"},
    {key:"orange",  color:"#FF8A00", label:"Î•Î½Î¸Î¿Ï…ÏƒÎ¹Î±ÏƒÎ¼ÏŒÏ‚ / Î•Î½Î­ÏÎ³ÎµÎ¹Î±"},
    {key:"pink",    color:"#FF4FD8", label:"Î‘Î³Î¬Ï€Î· / Î¤ÏÏ…Ï†ÎµÏÏŒÏ„Î·Ï„Î±"},
    {key:"green",   color:"#22C55E", label:"Î—ÏÎµÎ¼Î¯Î± / Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î±"},
    {key:"lblue",   color:"#5AD7FF", label:"Î“Î±Î»Î®Î½Î· / Î§Î±Î»Î¬ÏÏ‰ÏƒÎ·"},
    {key:"lpurple", color:"#A78BFA", label:"Î ÎµÏÎ¹Î­ÏÎ³ÎµÎ¹Î± / Î•Î½Î´Î¹Î±Ï†Î­ÏÎ¿Î½"},
    {key:"lgray",   color:"#D1D5DB", label:"Î Î»Î®Î¾Î· / Î‘Î´Î¹Î±Ï†Î¿ÏÎ¯Î±"},
    {key:"dgray",   color:"#6B7280", label:"Î˜Î»Î¯ÏˆÎ· / Î£Ï„ÎµÎ½Î±Ï‡ÏÏÎ¹Î±"},
    {key:"dblue",   color:"#1F3B88", label:"ÎœÎ¿Î½Î±Î¾Î¹Î¬ / Î‘Ï€Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ·"},
    {key:"brown",   color:"#A16207", label:"Î£ÏÎ³Ï‡Ï…ÏƒÎ· / Î‘Î¼Î·Ï‡Î±Î½Î¯Î±"},
    {key:"red",     color:"#EF4444", label:"Î˜Ï…Î¼ÏŒÏ‚ / Î•ÎºÎ½ÎµÏ…ÏÎ¹ÏƒÎ¼ÏŒÏ‚"},
    {key:"black",   color:"#111827", label:"Î¦ÏŒÎ²Î¿Ï‚ / Î¤ÏÏŒÎ¼Î¿Ï‚"},
    {key:"dpurple", color:"#7C3AED", label:"ÎÏ„ÏÎ¿Ï€Î® / Î•Î½Î¿Ï‡Î®"},
    {key:"white",   color:"#FFFFFF", label:"Î¤Î¯Ï€Î¿Ï„Î± / Î”ÎµÎ½ Î½Î¹ÏÎ¸Ï‰ Ï„Î¯Ï€Î¿Ï„Î±"},
  ];

  const INTENSITIES = ["Î›Î¯Î³Î¿","ÎœÎ­Ï„ÏÎ¹Î±","Î‘ÏÎºÎµÏ„Î¬","Î Î¿Î»Ï","Î Î¬ÏÎ± Ï€Î¿Î»Ï"];

  const WITH_WHOM = [
    "ÎœÎ·Ï„Î­ÏÎ±","Î Î±Ï„Î­ÏÎ±Ï‚","Î‘Î´ÎµÏÏ†ÏŒÏ‚/Î‘Î´ÎµÏÏ†Î® (Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿Ï‚/Î·)","Î‘Î´ÎµÏÏ†ÏŒÏ‚/Î‘Î´ÎµÏÏ†Î® (Î¼Î¹ÎºÏÏŒÏ„ÎµÏÎ¿Ï‚/Î·)",
    "Î Î±Ï€Ï€Î¿ÏÏ‚ (Ï€Î±Ï„ÏÎ¹ÎºÏŒÏ‚)","Î“Î¹Î±Î³Î¹Î¬ (Ï€Î±Ï„ÏÎ¹ÎºÎ®)","Î Î±Ï€Ï€Î¿ÏÏ‚ (Î¼Î·Ï„ÏÎ¹ÎºÏŒÏ‚)","Î“Î¹Î±Î³Î¹Î¬ (Î¼Î·Ï„ÏÎ¹ÎºÎ®)",
    "Î˜ÎµÎ¯Î¿Ï‚","Î˜ÎµÎ¯Î±","ÎÎ¬Î´ÎµÏÏ†Î¿Ï‚/ÎÎ±Î´Î­ÏÏ†Î·","Î Î±Ï„ÏÎ¹ÏŒÏ‚/ÎœÎ·Ï„ÏÎ¹Î¬","Î£ÏÎ½Ï„ÏÎ¿Ï†Î¿Ï‚ Î¼Î·Ï„Î­ÏÎ±Ï‚/Ï€Î±Ï„Î­ÏÎ±",
    "Î”Î¬ÏƒÎºÎ±Î»Î¿Ï‚/Î”Î±ÏƒÎºÎ¬Î»Î±","Î¦Î¯Î»Î¿Ï‚/Î¦Î¯Î»Î· (ÏƒÏ…Î½Î¿Î¼Î®Î»Î¹ÎºÎ¿Ï‚)","Î“ÎµÎ¯Ï„Î¿Î½Î±Ï‚/Î“ÎµÎ¹Ï„ÏŒÎ½Î¹ÏƒÏƒÎ±",
    "Î ÏÎ¿Ï€Î¿Î½Î·Ï„Î®Ï‚/Î ÏÎ¿Ï€Î¿Î½Î®Ï„ÏÎ¹Î±","ÎÏ„Î±Î½Ï„Î¬/Babysitter","Î†Î³Î½Ï‰ÏƒÏ„Î¿ Î¬Ï„Î¿Î¼Î¿","ÎœÏŒÎ½Î¿Ï‚ Î¼Î¿Ï… / ÎšÎ±Î½ÎµÎ¯Ï‚"
  ];

  const EVENTS = [
    "Î§Î±Î¼ÏŒÎ³ÎµÎ»Î±","Î‘Î³ÎºÎ±Î»Î¹Î­Ï‚/Î§Î¬Î´Î¹Î±","Î Î±Î¹Ï‡Î½Î¯Î´Î¹","Î”Î¹Î¬Î²Î±ÏƒÎ¼Î±/ÎœÎ¬Î¸Î·ÏƒÎ·","Î¦Î±Î³Î·Ï„ÏŒ Î¼Î±Î¶Î¯","Î£Ï…Î¶Î®Ï„Î·ÏƒÎ·/ÎšÎ¿Ï…Î²Î­Î½Ï„Î±",
    "Î¤ÏÎ±Î³Î¿ÏÎ´Î¹/ÎœÎ¿Ï…ÏƒÎ¹ÎºÎ®","Î‘Î¸Î»Î·Ï„Î¹ÏƒÎ¼ÏŒÏ‚","ÎÏ€Î½Î¿Ï‚/ÎÎµÎºÎ¿ÏÏÎ±ÏƒÎ·","Î¤Î·Î»ÎµÏŒÏÎ±ÏƒÎ·/Tablet","ÎœÏŒÎ½Î¿Ï‚/Î· ÏƒÏ„Î¿ Î´Ï‰Î¼Î¬Ï„Î¹Î¿",
    "Î”Î¿Ï…Î»ÎµÎ¹Î­Ï‚/ÎšÎ±Î¸Î®ÎºÎ¿Î½Ï„Î±","ÎœÎµÏ„Î±ÎºÎ¯Î½Î·ÏƒÎ·","Î¦Ï‰Î½Î­Ï‚/Î¤ÏƒÎ±ÎºÏ‰Î¼ÏŒÏ‚","Î§Ï„Ï…Ï€Î®Î¼Î±Ï„Î±","ÎšÎ»Î¬Î¼Î±Ï„Î±","Î¦ÏŒÎ²Î¿Ï‚/Î¤ÏÎ¿Î¼Î¬ÏÎ±",
    "Î¤Î¹Î¼Ï‰ÏÎ¯Î±","Î‘Ï€ÎµÎ¹Î»Î­Ï‚","Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·/ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚","ÎœÏ…ÏƒÏ„Î¹ÎºÎ¬/ÎÎ± Î¼Î·Î½ Ï€Ï‰","Î‘Î´Î¹Î±Ï†Î¿ÏÎ¯Î±/Î Î±ÏÎ±Î¼Î­Î»Î·ÏƒÎ·","ÎÏ„ÏÎ¿Ï€Î®/Î•Î¾ÎµÏ…Ï„ÎµÎ»Î¹ÏƒÎ¼ÏŒÏ‚"
  ];

  const LOCATIONS = [
    "Î£Ï€Î¯Ï„Î¹ Î¼Î¿Ï…","Î¥Ï€Î½Î¿Î´Ï‰Î¼Î¬Ï„Î¹ÏŒ Î¼Î¿Ï…","ÎšÎ¿Ï…Î¶Î¯Î½Î±/Î¤ÏÎ±Ï€ÎµÎ¶Î±ÏÎ¯Î±","Î£Î±Î»ÏŒÎ½Î¹","ÎœÏ€Î¬Î½Î¹Î¿","Î‘Ï…Î»Î®/ÎœÏ€Î±Î»ÎºÏŒÎ½Î¹",
    "Î£Ï€Î¯Ï„Î¹ Ï€Î±Ï€Ï€Î¿Ï-Î³Î¹Î±Î³Î¹Î¬Ï‚","Î£Ï€Î¯Ï„Î¹ Ï†Î¯Î»Î¿Ï…","Î£Ï‡Î¿Î»ÎµÎ¯Î¿ (Ï„Î¬Î¾Î·)","Î£Ï‡Î¿Î»ÎµÎ¯Î¿ (Î´Î¹Î¬Î»ÎµÎ¹Î¼Î¼Î±/Î±Ï…Î»Î®)",
    "Î“Î®Ï€ÎµÎ´Î¿/Î“Ï…Î¼Î½Î±ÏƒÏ„Î®ÏÎ¹Î¿","Î¦ÏÎ¿Î½Ï„Î¹ÏƒÏ„Î®ÏÎ¹Î¿/Î”ÏÎ±ÏƒÏ„Î·ÏÎ¹ÏŒÏ„Î·Ï„ÎµÏ‚","Î Î¬ÏÎºÎ¿/Î Î±Î¹Î´Î¹ÎºÎ® Ï‡Î±ÏÎ¬",
    "ÎœÎ±Î³Î±Î¶Î¯/Î£Î¿ÏÏ€ÎµÏ Î¼Î¬ÏÎºÎµÏ„","Î‘Ï…Ï„Î¿ÎºÎ¯Î½Î·Ï„Î¿","Î“Î¹Î±Ï„ÏÏŒÏ‚/ÎÎ¿ÏƒÎ¿ÎºÎ¿Î¼ÎµÎ¯Î¿","Î•ÎºÎºÎ»Î·ÏƒÎ¯Î±","Î†Î³Î½Ï‰ÏƒÏ„Î¿ Î¼Î­ÏÎ¿Ï‚"
  ];

  const FREQUENCY = [
    "ÎšÎ¬Î¸Îµ Î¼Î­ÏÎ±",
    "Î£Ï…Ï‡Î½Î¬ (3-4 Ï†Î¿ÏÎ­Ï‚/ÎµÎ²Î´Î¿Î¼Î¬Î´Î±)",
    "ÎœÎµÏÎ¹ÎºÎ­Ï‚ Ï†Î¿ÏÎ­Ï‚ (1-2 Ï†Î¿ÏÎ­Ï‚/ÎµÎ²Î´Î¿Î¼Î¬Î´Î±)",
    "Î£Ï€Î¬Î½Î¹Î±"
  ];

  const DEFAULT_ENTRY = () => ({
    emotionKey: null,
    intensity: null,
    withWhom: "",
    events: [],
    location: "",
    frequency: ""
  });

  const STORAGE_KEY = "chronofeel24_v1";

  let state = {
    participant: { name:"", age:"", sex:"" },
    safeMostHour: null,
    safeLeastHour: null,
    entries: Object.fromEntries(HOURS.map(h=>[h, DEFAULT_ENTRY()])),
    selectedHour: "00:00"
  };

  // ------- Helpers -------
  const $ = (id) => document.getElementById(id);
  const saveStatus = $("saveStatus");

  function setSaved(flag){
    saveStatus.textContent = flag ? "â— saved" : "â— savingâ€¦";
    saveStatus.style.color = flag ? "var(--muted)" : "var(--warn)";
  }
  function deepCopy(obj){ return JSON.parse(JSON.stringify(obj)); }
  function autosave(){
    setSaved(false);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    setTimeout(()=>setSaved(true), 120);
  }
  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    try{
      const s = JSON.parse(raw);
      if(s && s.entries) state = s;
    }catch(e){}
  }
  function hourIndex(h){ return HOURS.indexOf(h); }
  function selectedEntry(){ return state.entries[state.selectedHour]; }
  function emotionByKey(key){ return EMOTIONS.find(e=>e.key===key) || null; }

  function setSelectedHour(h){
    state.selectedHour = h;
    $("selectedHourLabel").textContent = h;
    renderHours();
    renderEditor();
    autosave();
  }

  // ------- UI build -------
  function buildPalette(){
    const wrap = $("palette");
    wrap.innerHTML = "";
    EMOTIONS.forEach(e=>{
      const d = document.createElement("div");
      d.className = "sw";
      d.setAttribute("role","button");
      d.setAttribute("tabindex","0");
      d.dataset.key = e.key;
      // Show ONLY the color (no label text)
      d.innerHTML = `<div class="c" style="background:${e.color}"></div>`;
      d.title = "Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï‡ÏÏÎ¼Î±";
      d.setAttribute("aria-label", "Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï‡ÏÏÎ¼Î±");
      d.addEventListener("click", ()=> {
        selectedEntry().emotionKey = e.key;
        // keep intensity as is (do not erase); user controls it
        autosave();
        renderEditor();
        renderHours();
      });
      wrap.appendChild(d);
    });
  }

  function buildIntensity(){
    const wrap = $("intensityPills");
    wrap.innerHTML = "";
    INTENSITIES.forEach(label=>{
      const p = document.createElement("div");
      p.className="pill";
      p.textContent = label;
      p.dataset.intensity = label;
      p.addEventListener("click", ()=>{
        // Only allow if emotion selected (guard also in code)
        if(!selectedEntry().emotionKey) return;
        selectedEntry().intensity = label;
        autosave();
        renderEditor();
        renderHours();
      });
      wrap.appendChild(p);
    });
  }

  function setIntensityEnabled(enabled){
    const hint = $("intensityHint");
    hint.style.display = enabled ? "none" : "block";
    document.querySelectorAll("#intensityPills .pill").forEach(p=>{
      p.style.pointerEvents = enabled ? "auto" : "none";
      p.style.opacity = enabled ? "1" : "0.45";
      p.style.transform = "none";
    });
  }

  function fillSelect(sel, options, placeholder){
    sel.innerHTML = "";
    if(placeholder){
      const o = document.createElement("option");
      o.value = "";
      o.textContent = placeholder;
      sel.appendChild(o);
    }
    options.forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    });
  }

  function buildHours(){
    const grid = $("hoursGrid");
    grid.innerHTML = "";
    HOURS.forEach(h=>{
      const el = document.createElement("div");
      el.className = "hour";
      el.dataset.hour = h;
      el.addEventListener("click", ()=> setSelectedHour(h));
      grid.appendChild(el);
    });
  }

  function shorten(s, n){
    if(!s) return "";
    return s.length<=n ? s : s.slice(0,n-1) + "â€¦";
  }

  function renderHours(){
    document.querySelectorAll(".hour").forEach(el=>{
      const h = el.dataset.hour;
      const entry = state.entries[h];
      const emo = emotionByKey(entry.emotionKey);
      const dotColor = emo ? emo.color : "transparent";

      el.classList.toggle("sel", h===state.selectedHour);

      const tags = [];
      if(state.safeMostHour === h) tags.push(`<span class="tag safe">âœ… Î±ÏƒÏ†Î±Î»Î®Ï‚</span>`);
      if(state.safeLeastHour === h) tags.push(`<span class="tag risk">âŒ ÏŒÏ‡Î¹ Î±ÏƒÏ†Î±Î»Î®Ï‚</span>`);

      const withMini = entry.withWhom ? `ğŸ‘¥ ${shorten(entry.withWhom, 16)}` : "";
      const locMini  = entry.location ? `ğŸ“ ${shorten(entry.location, 16)}` : "";
      const intMini  = entry.intensity ? `âš¡ ${shorten(entry.intensity, 10)}` : "";

      el.innerHTML = `
        <div class="t">${h}</div>
        <div class="mini">
          <span class="dot" style="background:${dotColor}"></span>
          ${intMini ? `<span>${intMini}</span>` : `<span class="small">â€”</span>`}
          ${withMini ? `<span>${withMini}</span>` : ``}
          ${locMini ? `<span>${locMini}</span>` : ``}
        </div>
        <div class="mini" style="margin-top:8px;gap:6px">
          ${tags.join("")}
        </div>
      `;
    });
  }

  function renderEditor(){
    // sex pills
    document.querySelectorAll("#sexPills .pill").forEach(p=>{
      p.classList.toggle("active", p.dataset.sex === state.participant.sex);
    });

    // palette active
    document.querySelectorAll("#palette .sw").forEach(sw=>{
      sw.classList.toggle("active", sw.dataset.key === selectedEntry().emotionKey);
    });

    // intensity active + enable/disable logic
    const hasEmotion = !!selectedEntry().emotionKey;
    setIntensityEnabled(hasEmotion);

    document.querySelectorAll("#intensityPills .pill").forEach((p)=>{
      p.classList.toggle("active", p.dataset.intensity === selectedEntry().intensity);
    });

    // selects
    $("withWhom").value = selectedEntry().withWhom || "";
    $("location").value = selectedEntry().location || "";
    $("frequency").value = selectedEntry().frequency || "";

    // events multi
    const evSel = $("events");
    Array.from(evSel.options).forEach(opt=>{
      opt.selected = selectedEntry().events.includes(opt.value);
    });

    // participant
    $("name").value = state.participant.name || "";
    $("age").value = state.participant.age || "";
  }

  function hookInputs(){
    $("name").addEventListener("input", e=>{
      state.participant.name = e.target.value.trim();
      autosave();
    });
    $("age").addEventListener("input", e=>{
      state.participant.age = e.target.value;
      autosave();
    });

    document.querySelectorAll("#sexPills .pill").forEach(p=>{
      p.addEventListener("click", ()=>{
        state.participant.sex = p.dataset.sex;
        autosave();
        renderEditor();
      });
    });

    $("withWhom").addEventListener("change", e=>{
      selectedEntry().withWhom = e.target.value;
      autosave(); renderHours();
    });
    $("location").addEventListener("change", e=>{
      selectedEntry().location = e.target.value;
      autosave(); renderHours();
    });
    $("frequency").addEventListener("change", e=>{
      selectedEntry().frequency = e.target.value;
      autosave(); renderHours();
    });

    $("events").addEventListener("change", e=>{
      const vals = Array.from(e.target.selectedOptions).map(o=>o.value);
      selectedEntry().events = vals;
      autosave(); renderHours();
    });

    $("btnSafeMost").addEventListener("click", ()=>{
      state.safeMostHour = state.selectedHour;
      if(state.safeLeastHour === state.safeMostHour) state.safeLeastHour = null;
      autosave(); renderHours();
    });

    $("btnSafeLeast").addEventListener("click", ()=>{
      state.safeLeastHour = state.selectedHour;
      if(state.safeMostHour === state.safeLeastHour) state.safeMostHour = null;
      autosave(); renderHours();
    });

    $("btnCopyPrev").addEventListener("click", ()=>{
      const i = hourIndex(state.selectedHour);
      if(i<=0) return;
      const prev = HOURS[i-1];
      state.entries[state.selectedHour] = deepCopy(state.entries[prev]);
      autosave(); renderEditor(); renderHours();
    });

    $("btnApplyRange").addEventListener("click", ()=>{
      const from = prompt("Î‘Ï€ÏŒ Ï€Î¿Î¹Î± ÏÏÎ±; (Ï€.Ï‡. 08:00)", state.selectedHour) || "";
      const to   = prompt("ÎˆÏ‰Ï‚ Ï€Î¿Î¹Î± ÏÏÎ±; (Ï€.Ï‡. 12:00)", state.selectedHour) || "";
      if(!HOURS.includes(from) || !HOURS.includes(to)) { alert("Î›Î¬Î¸Î¿Ï‚ ÏÏÎµÏ‚."); return; }
      const a = hourIndex(from), b = hourIndex(to);
      const lo = Math.min(a,b), hi = Math.max(a,b);
      const src = deepCopy(state.entries[state.selectedHour]);
      for(let k=lo;k<=hi;k++){
        state.entries[HOURS[k]] = deepCopy(src);
      }
      autosave(); renderEditor(); renderHours();
    });

    $("btnSleep").addEventListener("click", ()=>{
      const start = prompt("ÎÏÎ± Î­Î½Î±ÏÎ¾Î·Ï‚ ÏÏ€Î½Î¿Ï…; (Ï€.Ï‡. 23:00)", "23:00") || "";
      const end   = prompt("ÎÏÎ± Î»Î®Î¾Î·Ï‚ ÏÏ€Î½Î¿Ï…; (Ï€.Ï‡. 07:00)", "07:00") || "";
      if(!HOURS.includes(start) || !HOURS.includes(end)) { alert("Î›Î¬Î¸Î¿Ï‚ ÏÏÎµÏ‚."); return; }

      // apply across midnight: [start..23] + [00..end]
      const fill = {
        emotionKey: "green",
        intensity: "ÎœÎ­Ï„ÏÎ¹Î±",
        withWhom: "ÎœÏŒÎ½Î¿Ï‚ Î¼Î¿Ï… / ÎšÎ±Î½ÎµÎ¯Ï‚",
        events: ["ÎÏ€Î½Î¿Ï‚/ÎÎµÎºÎ¿ÏÏÎ±ÏƒÎ·"],
        location: "Î¥Ï€Î½Î¿Î´Ï‰Î¼Î¬Ï„Î¹ÏŒ Î¼Î¿Ï…",
        frequency: "ÎšÎ¬Î¸Îµ Î¼Î­ÏÎ±"
      };

      const si = hourIndex(start);
      const ei = hourIndex(end);
      if(si <= ei){
        for(let k=si;k<=ei;k++) state.entries[HOURS[k]] = deepCopy(fill);
      }else{
        for(let k=si;k<24;k++) state.entries[HOURS[k]] = deepCopy(fill);
        for(let k=0;k<=ei;k++) state.entries[HOURS[k]] = deepCopy(fill);
      }
      autosave(); renderEditor(); renderHours();
    });

    $("btnExportJSON").addEventListener("click", ()=>{
      const out = buildExportObject();
      downloadFile("chronosynaisthima24.json", JSON.stringify(out, null, 2), "application/json");
    });

    $("btnExportCSV").addEventListener("click", ()=>{
      const csv = buildCSV();
      downloadFile("chronosynaisthima24.csv", csv, "text/csv;charset=utf-8");
    });

    $("btnReset").addEventListener("click", ()=>{
      if(!confirm("Î£Î¯Î³Î¿Ï…ÏÎ± reset; Î˜Î± Ï‡Î±Î¸Î¿ÏÎ½ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.")) return;
      localStorage.removeItem(STORAGE_KEY);
      state = {
        participant: { name:"", age:"", sex:"" },
        safeMostHour: null,
        safeLeastHour: null,
        entries: Object.fromEntries(HOURS.map(h=>[h, DEFAULT_ENTRY()])),
        selectedHour: "00:00"
      };
      renderEditor(); renderHours();
      autosave();
    });

    $("btnValidate").addEventListener("click", ()=>{
      const msg = validate();
      $("validationMsg").textContent = msg.ok ? "âœ… ÎŸÎš! ÎˆÏ„Î¿Î¹Î¼Î¿ Î³Î¹Î± export." : "âš  " + msg.error;
      $("validationMsg").style.color = msg.ok ? "var(--good)" : "var(--warn)";
    });
  }

  function validate(){
    if(!state.participant.name) return {ok:false, error:"Î›ÎµÎ¯Ï€ÎµÎ¹ ÎŒÎ½Î¿Î¼Î±."};
    if(!state.participant.age) return {ok:false, error:"Î›ÎµÎ¯Ï€ÎµÎ¹ Î—Î»Î¹ÎºÎ¯Î±."};
    if(!state.safeMostHour) return {ok:false, error:"Î”Î¹Î¬Î»ÎµÎ¾Îµ ÏÏÎ± Î Î™ÎŸ Î±ÏƒÏ†Î±Î»Î®Ï‚ (âœ… Most safe)."};
    if(!state.safeLeastHour) return {ok:false, error:"Î”Î¹Î¬Î»ÎµÎ¾Îµ ÏÏÎ± Î›Î™Î“ÎŸÎ¤Î•Î¡ÎŸ Î±ÏƒÏ†Î±Î»Î®Ï‚ (âŒ Least safe)."};
    if(state.safeMostHour === state.safeLeastHour) return {ok:false, error:"Î— Î¯Î´Î¹Î± ÏÏÎ± Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ ÎºÎ±Î¹ most & least safe."};
    return {ok:true};
  }

  function buildExportObject(){
    return {
      tool: "Î§ÏÎ¿Î½Î¿Î£Ï…Î½Î±Î¯ÏƒÎ¸Î·Î¼Î± 24",
      version: "1.0",
      participant: deepCopy(state.participant),
      safeMostHour: state.safeMostHour,
      safeLeastHour: state.safeLeastHour,
      hours: HOURS.map(h => ({
        hour: h,
        ...deepCopy(state.entries[h]),
        // keep label in export (you can remove later if you want)
        emotionLabel: emotionByKey(state.entries[h].emotionKey)?.label || ""
      }))
    };
  }

  function csvEscape(v){
    const s = (v ?? "").toString();
    if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  }

  function buildCSV(){
    const header = [
      "name","age","sex","hour",
      "emotion_color","emotion_label",
      "intensity","with_whom","events","location","frequency",
      "safe_most","safe_least"
    ].join(",");

    const rows = HOURS.map(h=>{
      const e = state.entries[h];
      const emo = emotionByKey(e.emotionKey);
      const events = (e.events || []).join("|");
      const safeMost = (state.safeMostHour===h) ? "1":"0";
      const safeLeast = (state.safeLeastHour===h) ? "1":"0";
      return [
        state.participant.name,
        state.participant.age,
        state.participant.sex,
        h,
        emo?.color || "",
        emo?.label || "",
        e.intensity || "",
        e.withWhom || "",
        events,
        e.location || "",
        e.frequency || "",
        safeMost,
        safeLeast
      ].map(csvEscape).join(",");
    });

    return [header, ...rows].join("\n");
  }

  function downloadFile(filename, content, mime){
    const blob = new Blob([content], {type:mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 800);
  }

  // ------- Init -------
  function init(){
    load();

    buildPalette();
    buildIntensity();
    fillSelect($("withWhom"), WITH_WHOM, "Î”Î¹Î¬Î»ÎµÎ¾Îµâ€¦");
    fillSelect($("location"), LOCATIONS, "Î”Î¹Î¬Î»ÎµÎ¾Îµâ€¦");
    fillSelect($("frequency"), FREQUENCY, "Î”Î¹Î¬Î»ÎµÎ¾Îµâ€¦");
    fillSelect($("events"), EVENTS, null);

    buildHours();
    hookInputs();

    renderHours();
    renderEditor();
    setSaved(true);
  }

  init();
</script>
</body>
</html>